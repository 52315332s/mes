<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MES ç»¼åˆä¿¡æ¯ä¸­å¿ƒ - é’¢é“çƒ­è½§ç”Ÿäº§çº¿ç®¡æ§ç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            margin: 0;
            padding: 10px;
            min-height: 100vh;
        }

        .main-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: 80px repeat(4, auto);
            gap: 15px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            min-height: 300px;
        }

        .panel-title {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }

        .btn-sm-custom {
            padding: 6px 12px;
            font-size: 12px;
            margin: 2px;
        }

        .yard-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
            margin-bottom: 15px;
        }

        .yard-cell {
            aspect-ratio: 1;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            color: #6c757d;
        }

        .yard-cell.occupied {
            background: #3498db;
            color: white;
            border: 2px solid #2980b9;
        }

        .yard-cell.finished {
            background: #27ae60;
            color: white;
            border: 2px solid #229954;
        }

        .production-line {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }

        .stage-box {
            width: 60px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: bold;
        }

        .stage-slab { background: #7f8c8d; }
        .stage-furnace { background: #e74c3c; }
        .stage-rolling { background: #f39c12; }
        .stage-coiler { background: #27ae60; }
        .stage-coil { background: #9b59b6; }

        .material-dot {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #34495e;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 8px;
            transition: all 1s ease;
            z-index: 10;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }

        .status-running { background: #27ae60; }
        .status-idle { background: #f39c12; }
        .status-fault { background: #e74c3c; }

        .gauge-circle {
            width: 50px;
            height: 50px;
            border: 4px solid #ecf0f1;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-size: 10px;
            font-weight: bold;
        }

        .gauge-power { border-color: #e74c3c; color: #e74c3c; }
        .gauge-gas { border-color: #f39c12; color: #f39c12; }
        .gauge-water { border-color: #3498db; color: #3498db; }

        .system-log {
            height: 200px;
            overflow-y: auto;
            background: #2c3e50;
            color: #ecf0f1;
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 11px;
        }

        .log-info { color: #3498db; }
        .log-success { color: #27ae60; }
        .log-warning { color: #f39c12; }
        .log-error { color: #e74c3c; }

        .kpi-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .kpi-card {
            text-align: center;
            background: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
        }

        .kpi-value {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
        }

        .kpi-label {
            font-size: 12px;
            color: #7f8c8d;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e74c3c;
            display: inline-block;
            margin-right: 8px;
        }

        .status-indicator.running {
            background: #27ae60;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .table-sm {
            font-size: 12px;
        }

        .badge-sm {
            font-size: 10px;
            padding: 2px 6px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <div>
                <h4 class="mb-0">ğŸ­ MES ç»¼åˆä¿¡æ¯ä¸­å¿ƒ</h4>
                <small>é’¢é“çƒ­è½§ç”Ÿäº§çº¿åˆ¶é€ æ‰§è¡Œç³»ç»Ÿ</small>
            </div>
            <div>
                <span class="status-indicator" id="simStatus"></span>
                <span id="simText">ç³»ç»Ÿåœæ­¢</span>
                <button class="btn btn-light btn-sm ms-3" onclick="toggleSimulation()" id="toggleBtn">
                    å¯åŠ¨ç³»ç»Ÿ
                </button>
                <small class="ms-3">æ—¶é—´: <span id="systemTime">--:--:--</span></small>
            </div>
        </div>

        <!-- Panel 1: ç”Ÿäº§è®¡åˆ’ç®¡ç† -->
        <div class="panel">
            <div class="panel-title">ğŸ“‹ ç”Ÿäº§è®¡åˆ’ç®¡ç†</div>
            <table class="table table-sm">
                <thead class="table-dark">
                    <tr>
                        <th>è®¢å•å·</th>
                        <th>ç‰©æ–™å·</th>
                        <th>é’¢ç§</th>
                        <th>çŠ¶æ€</th>
                    </tr>
                </thead>
                <tbody id="planningTable">
                    <!-- æ•°æ®ç”±JavaScriptå¡«å…… -->
                </tbody>
            </table>
            <div class="mt-3">
                <button class="btn btn-primary btn-sm-custom" onclick="optimizeSchedule()">
                    ğŸ”§ ä¼˜åŒ–æ’ç¨‹
                </button>
                <button class="btn btn-success btn-sm-custom" onclick="dispatchPlan()">
                    ğŸš€ ä¸‹è¾¾è®¡åˆ’
                </button>
                <button class="btn btn-secondary btn-sm-custom" onclick="resetPlanning()">
                    ğŸ”„ é‡ç½®
                </button>
            </div>
        </div>

        <!-- Panel 2: åº“åŒºç®¡ç† -->
        <div class="panel">
            <div class="panel-title">ğŸ—ï¸ æ¿å¯ä¸é’¢å·åº“åŒºç®¡ç†</div>
            <h6>æ¿å¯åº“ (Slab Yard)</h6>
            <div class="yard-grid" id="slabYard">
                <!-- ç”±JavaScriptç”Ÿæˆ -->
            </div>
            <p><small>åº“å­˜: <span id="slabCount">15</span> | å¨ä½: <span id="slabTonnage">450</span>t</small></p>
            
            <h6>é’¢å·åº“ (Coil Yard)</h6>
            <div class="yard-grid" id="coilYard">
                <!-- ç”±JavaScriptç”Ÿæˆ -->
            </div>
            <p><small>åº“å­˜: <span id="coilCount">0</span> | å¨ä½: <span id="coilTonnage">0</span>t</small></p>
        </div>

        <!-- Panel 3: ç‰©æ–™è·Ÿè¸ªç®¡ç† -->
        <div class="panel">
            <div class="panel-title">ğŸ“ ç‰©æ–™è·Ÿè¸ªç®¡ç†</div>
            <div class="production-line">
                <div class="stage-box stage-slab">æ¿å¯åº“</div>
                <div class="stage-box stage-furnace">åŠ çƒ­ç‚‰</div>
                <div class="stage-box stage-rolling">è½§æœº</div>
                <div class="stage-box stage-coiler">å·å–æœº</div>
                <div class="stage-box stage-coil">é’¢å·åº“</div>
                <div class="material-dot" id="materialDot" style="display: none;">M</div>
            </div>
            <div class="mt-3">
                <table class="table table-sm">
                    <tr><td><strong>å½“å‰ç‰©æ–™:</strong></td><td id="currentMaterial">--</td></tr>
                    <tr><td><strong>é’¢ç§:</strong></td><td id="currentGrade">--</td></tr>
                    <tr><td><strong>å½“å‰æ¸©åº¦:</strong></td><td id="currentTemp">--</td></tr>
                    <tr><td><strong>å½“å‰ä½ç½®:</strong></td><td id="currentPos">--</td></tr>
                </table>
            </div>
        </div>

        <!-- Panel 4: è´¨é‡ç®¡ç† -->
        <div class="panel">
            <div class="panel-title">ğŸ“Š è´¨é‡ç®¡ç†</div>
            <div style="height: 150px; margin-bottom: 15px;">
                <canvas id="spcChart"></canvas>
            </div>
            <div>
                <h6>è´¨é‡æŠ¥è­¦æ—¥å¿—</h6>
                <div style="height: 100px; overflow-y: auto; background: #f8f9fa; padding: 8px; border-radius: 4px; font-size: 11px;" id="qualityLog">
                    <div style="color: #27ae60;">[ä¿¡æ¯] è´¨é‡ç›‘æ§ç³»ç»Ÿæ­£å¸¸</div>
                </div>
            </div>
        </div>

        <!-- Panel 5: è®¾å¤‡ç®¡ç† -->
        <div class="panel">
            <div class="panel-title">âš™ï¸ è®¾å¤‡ç®¡ç†</div>
            <h6>å…³é”®è®¾å¤‡çŠ¶æ€</h6>
            <table class="table table-sm">
                <thead>
                    <tr><th>è®¾å¤‡</th><th>çŠ¶æ€</th><th>è´Ÿè½½</th></tr>
                </thead>
                <tbody id="equipmentTable">
                    <!-- ç”±JavaScriptå¡«å…… -->
                </tbody>
            </table>
            <h6 class="mt-3">è½§è¾Šä¿¡æ¯</h6>
            <table class="table table-sm">
                <thead>
                    <tr><th>æœºæ¶</th><th>è½§è¾ŠID</th><th>è¿‡é’¢é‡(t)</th></tr>
                </thead>
                <tbody id="rollTable">
                    <!-- ç”±JavaScriptå¡«å…… -->
                </tbody>
            </table>
        </div>

        <!-- Panel 6: èƒ½æºç®¡ç† -->
        <div class="panel">
            <div class="panel-title">âš¡ èƒ½æºç®¡ç†</div>
            <div class="d-flex justify-content-around mb-3">
                <div class="text-center">
                    <div class="gauge-circle gauge-power">
                        <span id="powerValue">25</span>
                    </div>
                    <small>åŠŸç‡(MW)</small>
                </div>
                <div class="text-center">
                    <div class="gauge-circle gauge-gas">
                        <span id="gasValue">15k</span>
                    </div>
                    <small>ç…¤æ°”æµé‡</small>
                </div>
                <div class="text-center">
                    <div class="gauge-circle gauge-water">
                        <span id="waterValue">800</span>
                    </div>
                    <small>å¾ªç¯æ°´</small>
                </div>
            </div>
            <div class="text-center">
                <h6>æœ¬ç­æ¬¡èƒ½æºæˆæœ¬</h6>
                <h4>Â¥ <span id="energyCost">150,345</span></h4>
            </div>
        </div>

        <!-- Panel 7: æ•°æ®é‡‡é›† -->
        <div class="panel">
            <div class="panel-title">ğŸ”Œ æ•°æ®é‡‡é›†</div>
            <div class="system-log" id="systemLog">
                <div class="log-info">[INFO] MESç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ</div>
                <div class="log-success">[SUCCESS] æ•°æ®åº“è¿æ¥æ­£å¸¸</div>
                <div class="log-info">[INFO] OPC-UAæœåŠ¡å™¨å°±ç»ª</div>
            </div>
        </div>

        <!-- Panel 8: ç”Ÿäº§æŠ¥è¡¨ -->
        <div class="panel">
            <div class="panel-title">ğŸ“ˆ ç”Ÿäº§ç»Ÿè®¡æŠ¥è¡¨</div>
            <div class="kpi-grid">
                <div class="kpi-card">
                    <div class="kpi-value" id="yieldRate">97.5%</div>
                    <div class="kpi-label">æˆæç‡</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="oeeRate">85%</div>
                    <div class="kpi-label">è®¾å¤‡æ•ˆç‡</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-value" id="planRate">99%</div>
                    <div class="kpi-label">è®¡åˆ’å®Œæˆç‡</div>
                </div>
            </div>
            <table class="table table-sm">
                <thead>
                    <tr><th>é’¢å·ID</th><th>é‡é‡</th><th>å®Œæˆæ—¶é—´</th><th>è´¨é‡</th></tr>
                </thead>
                <tbody id="reportsTable">
                    <tr><td colspan="4" class="text-center text-muted">æš‚æ— å®Œæˆäº§å“</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Panel 9: å·¥è‰ºæ§åˆ¶ -->
        <div class="panel">
            <div class="panel-title">âš¡ å·¥è‰ºå‚æ•°æ§åˆ¶</div>
            <div class="mb-3">
                <label class="form-label">åŠ çƒ­ç‚‰æ¸©åº¦è®¾å®š</label>
                <input type="range" class="form-range" min="1000" max="1400" value="1250" id="furnaceTemp">
                <small id="furnaceTempValue">1250â„ƒ</small>
            </div>
            <div class="mb-3">
                <label class="form-label">è½§åˆ¶é€Ÿåº¦è®¾å®š</label>
                <input type="range" class="form-range" min="5" max="25" value="15" id="rollingSpeed">
                <small id="rollingSpeedValue">15 m/s</small>
            </div>
            <div class="mt-4">
                <h6>å½“å‰å·¥è‰ºå‚æ•°</h6>
                <table class="table table-sm">
                    <tr><td>è½§åˆ¶åŠ›:</td><td id="rollingForce">0 kN</td></tr>
                    <tr><td>å·å–å¼ åŠ›:</td><td id="coilerTension">0 MPa</td></tr>
                    <tr><td>å‡ºå£åšåº¦:</td><td id="outletThickness">-- mm</td></tr>
                </table>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€
        let mesState = {
            isRunning: false,
            interval: null,
            currentMaterial: null,
            plans: [],
            completedCoils: [],
            equipment: {
                furnace: { status: 'idle', load: 0, temp: 1250 },
                rolling: { status: 'idle', load: 0, force: 0 },
                coiler: { status: 'idle', load: 0, tension: 0 }
            },
            energy: { power: 25, gas: 15000, water: 800, cost: 150345 },
            yards: { slabCount: 15, coilCount: 0, slabTonnage: 450, coilTonnage: 0 }
        };

        let spcChart;

        // åˆå§‹åŒ–è®¢å•æ•°æ®
        function generatePlans() {
            const grades = ['Q235B', 'Q345', 'SS400', 'Q460'];
            const plans = [];
            for (let i = 1; i <= 30; i++) {
                plans.push({
                    orderId: `ORD-2024-${String(i).padStart(3, '0')}`,
                    materialId: `SLAB-${String(i).padStart(3, '0')}`,
                    grade: grades[Math.floor(Math.random() * grades.length)],
                    status: 'å¾…æ’ç¨‹'
                });
            }
            return plans;
        }

        // åˆå§‹åŒ–ç³»ç»Ÿ
        function initSystem() {
            mesState.plans = generatePlans();
            updateSystemTime();
            initYards();
            updatePlanningTable();
            updateEquipmentTable();
            updateRollTable();
            initSPCChart();
            setupControllers();
            
            setInterval(updateSystemTime, 1000);
        }

        function updateSystemTime() {
            document.getElementById('systemTime').textContent = new Date().toLocaleTimeString();
        }

        function initYards() {
            const slabYard = document.getElementById('slabYard');
            const coilYard = document.getElementById('coilYard');
            
            // æ¿å¯åº“
            for (let i = 0; i < 24; i++) {
                const cell = document.createElement('div');
                cell.className = 'yard-cell';
                cell.textContent = i + 1;
                if (i < 15) {
                    cell.classList.add('occupied');
                    cell.textContent = `S${i + 1}`;
                }
                slabYard.appendChild(cell);
            }
            
            // é’¢å·åº“
            for (let i = 0; i < 24; i++) {
                const cell = document.createElement('div');
                cell.className = 'yard-cell';
                cell.textContent = i + 1;
                cell.id = `coil-cell-${i}`;
                coilYard.appendChild(cell);
            }
        }

        function updatePlanningTable() {
            const tbody = document.getElementById('planningTable');
            tbody.innerHTML = mesState.plans.slice(0, 8).map(plan => `
                <tr>
                    <td>${plan.orderId}</td>
                    <td>${plan.materialId}</td>
                    <td>${plan.grade}</td>
                    <td><span class="badge badge-sm ${getStatusClass(plan.status)}">${plan.status}</span></td>
                </tr>
            `).join('');
        }

        function getStatusClass(status) {
            switch(status) {
                case 'å¾…æ’ç¨‹': return 'bg-secondary';
                case 'å·²æ’ç¨‹': return 'bg-primary';
                case 'ç”Ÿäº§ä¸­': return 'bg-warning';
                case 'å·²å®Œæˆ': return 'bg-success';
                default: return 'bg-secondary';
            }
        }

        function updateEquipmentTable() {
            const tbody = document.getElementById('equipmentTable');
            tbody.innerHTML = `
                <tr>
                    <td>åŠ çƒ­ç‚‰</td>
                    <td><span class="status-dot status-${mesState.equipment.furnace.status}"></span>${getStatusText(mesState.equipment.furnace.status)}</td>
                    <td>${mesState.equipment.furnace.load}%</td>
                </tr>
                <tr>
                    <td>è½§æœº</td>
                    <td><span class="status-dot status-${mesState.equipment.rolling.status}"></span>${getStatusText(mesState.equipment.rolling.status)}</td>
                    <td>${mesState.equipment.rolling.load}%</td>
                </tr>
                <tr>
                    <td>å·å–æœº</td>
                    <td><span class="status-dot status-${mesState.equipment.coiler.status}"></span>${getStatusText(mesState.equipment.coiler.status)}</td>
                    <td>${mesState.equipment.coiler.load}%</td>
                </tr>
            `;
        }

        function updateRollTable() {
            const tbody = document.getElementById('rollTable');
            tbody.innerHTML = `
                <tr><td>F1</td><td>R1-2024-A</td><td>125.5</td></tr>
                <tr><td>F2</td><td>R2-2024-B</td><td>125.5</td></tr>
                <tr><td>F3</td><td>R3-2024-C</td><td>68.2</td></tr>
                <tr><td>F4</td><td>R4-2024-D</td><td>68.2</td></tr>
            `;
        }

        function getStatusText(status) {
            return { 'running': 'è¿è¡Œ', 'idle': 'ç©ºé—²', 'fault': 'æ•…éšœ' }[status] || status;
        }

        function initSPCChart() {
            const ctx = document.getElementById('spcChart').getContext('2d');
            spcChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'æ¸©åº¦',
                        data: [],
                        borderColor: '#3498db',
                        borderWidth: 2,
                        pointRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { min: 800, max: 1000 }
                    }
                }
            });
        }

        function setupControllers() {
            document.getElementById('furnaceTemp').addEventListener('input', function() {
                document.getElementById('furnaceTempValue').textContent = this.value + 'â„ƒ';
                mesState.equipment.furnace.temp = parseInt(this.value);
            });
            
            document.getElementById('rollingSpeed').addEventListener('input', function() {
                document.getElementById('rollingSpeedValue').textContent = this.value + ' m/s';
            });
        }

        // æ§åˆ¶å‡½æ•°
        function optimizeSchedule() {
            mesState.plans = mesState.plans.filter(p => p.status === 'å¾…æ’ç¨‹')
                .sort((a, b) => a.grade.localeCompare(b.grade))
                .map(p => ({ ...p, status: 'å·²æ’ç¨‹' }))
                .concat(mesState.plans.filter(p => p.status !== 'å¾…æ’ç¨‹'));
            updatePlanningTable();
            addLog('success', 'ç”Ÿäº§è®¡åˆ’ä¼˜åŒ–å®Œæˆ');
        }

        function dispatchPlan() {
            const plan = mesState.plans.find(p => p.status === 'å·²æ’ç¨‹');
            if (!plan) {
                addLog('warning', 'æ²¡æœ‰å·²æ’ç¨‹çš„è®¡åˆ’');
                return;
            }
            
            plan.status = 'ç”Ÿäº§ä¸­';
            mesState.currentMaterial = {
                ...plan,
                stage: 0,
                temp: 25,
                thickness: 250
            };
            
            updatePlanningTable();
            updateTrackingPanel();
            addLog('success', `ä¸‹è¾¾è®¡åˆ’: ${plan.materialId}`);
            
            if (!mesState.isRunning) {
                toggleSimulation();
            }
        }

        function resetPlanning() {
            mesState.plans.forEach(p => {
                if (p.status !== 'å·²å®Œæˆ') p.status = 'å¾…æ’ç¨‹';
            });
            mesState.currentMaterial = null;
            updatePlanningTable();
            updateTrackingPanel();
            addLog('info', 'è®¡åˆ’å·²é‡ç½®');
        }

        function toggleSimulation() {
            if (mesState.isRunning) {
                stopSimulation();
            } else {
                startSimulation();
            }
        }

        function startSimulation() {
            mesState.isRunning = true;
            mesState.interval = setInterval(simulationTick, 2000);
            
            document.getElementById('simStatus').classList.add('running');
            document.getElementById('simText').textContent = 'ç³»ç»Ÿè¿è¡Œ';
            document.getElementById('toggleBtn').textContent = 'åœæ­¢ç³»ç»Ÿ';
            
            addLog('success', 'MESç³»ç»Ÿå¯åŠ¨');
        }

        function stopSimulation() {
            mesState.isRunning = false;
            if (mesState.interval) {
                clearInterval(mesState.interval);
            }
            
            document.getElementById('simStatus').classList.remove('running');
            document.getElementById('simText').textContent = 'ç³»ç»Ÿåœæ­¢';
            document.getElementById('toggleBtn').textContent = 'å¯åŠ¨ç³»ç»Ÿ';
            
            addLog('info', 'MESç³»ç»Ÿåœæ­¢');
        }

        function simulationTick() {
            updateMaterial();
            updateEquipment();
            updateEnergy();
            updateSPC();
            generateLogs();
            updateAllPanels();
        }

        function updateMaterial() {
            if (!mesState.currentMaterial) return;
            
            const material = mesState.currentMaterial;
            const positions = ['5%', '25%', '45%', '65%', '85%'];
            const stageNames = ['æ¿å¯åº“', 'åŠ çƒ­ç‚‰', 'è½§æœº', 'å·å–æœº', 'é’¢å·åº“'];
            
            if (material.stage < 4) {
                material.stage++;
                
                const dot = document.getElementById('materialDot');
                dot.style.display = 'block';
                dot.style.left = positions[material.stage];
                
                // æ›´æ–°å·¥è‰ºå‚æ•°
                switch(material.stage) {
                    case 1:
                        material.temp = mesState.equipment.furnace.temp;
                        mesState.equipment.furnace.status = 'running';
                        mesState.equipment.furnace.load = 75;
                        break;
                    case 2:
                        mesState.equipment.furnace.status = 'idle';
                        mesState.equipment.furnace.load = 0;
                        mesState.equipment.rolling.status = 'running';
                        mesState.equipment.rolling.load = 85;
                        mesState.equipment.rolling.force = 2500;
                        material.thickness = 3.0;
                        break;
                    case 3:
                        mesState.equipment.rolling.status = 'idle';
                        mesState.equipment.rolling.load = 0;
                        mesState.equipment.rolling.force = 0;
                        mesState.equipment.coiler.status = 'running';
                        mesState.equipment.coiler.load = 60;
                        mesState.equipment.coiler.tension = 180;
                        break;
                    case 4:
                        mesState.equipment.coiler.status = 'idle';
                        mesState.equipment.coiler.load = 0;
                        mesState.equipment.coiler.tension = 0;
                        
                        // å®Œæˆç”Ÿäº§
                        const coil = {
                            materialId: material.materialId,
                            weight: (Math.random() * 50 + 150).toFixed(1) + 't',
                            time: new Date().toLocaleTimeString(),
                            quality: Math.random() > 0.1 ? 'åˆæ ¼' : 'ä¸åˆæ ¼'
                        };
                        
                        mesState.completedCoils.push(coil);
                        addCoilToYard();
                        
                        const plan = mesState.plans.find(p => p.materialId === material.materialId);
                        if (plan) plan.status = 'å·²å®Œæˆ';
                        
                        mesState.currentMaterial = null;
                        dot.style.display = 'none';
                        
                        addLog('success', `${material.materialId} ç”Ÿäº§å®Œæˆ`);
                        break;
                }
                
                addLog('info', `${material.materialId} è¿›å…¥${stageNames[material.stage]}`);
            }
        }

        function updateTrackingPanel() {
            const material = mesState.currentMaterial;
            if (!material) {
                document.getElementById('currentMaterial').textContent = '--';
                document.getElementById('currentGrade').textContent = '--';
                document.getElementById('currentTemp').textContent = '--';
                document.getElementById('currentPos').textContent = '--';
                document.getElementById('materialDot').style.display = 'none';
                return;
            }
            
            const stageNames = ['æ¿å¯åº“', 'åŠ çƒ­ç‚‰', 'è½§æœº', 'å·å–æœº', 'é’¢å·åº“'];
            document.getElementById('currentMaterial').textContent = material.materialId;
            document.getElementById('currentGrade').textContent = material.grade;
            document.getElementById('currentTemp').textContent = material.temp + 'â„ƒ';
            document.getElementById('currentPos').textContent = stageNames[material.stage];
        }

        function addCoilToYard() {
            for (let i = 0; i < 24; i++) {
                const cell = document.getElementById(`coil-cell-${i}`);
                if (!cell.classList.contains('finished')) {
                    cell.classList.add('finished');
                    cell.textContent = `C${mesState.yards.coilCount + 1}`;
                    break;
                }
            }
            
            mesState.yards.coilCount++;
            mesState.yards.coilTonnage += Math.round(Math.random() * 50 + 150);
            
            document.getElementById('coilCount').textContent = mesState.yards.coilCount;
            document.getElementById('coilTonnage').textContent = mesState.yards.coilTonnage;
        }

        function updateEquipment() {
            // éšæœºæ•…éšœ
            if (Math.random() < 0.01) {
                const equipments = ['furnace', 'rolling', 'coiler'];
                const eq = equipments[Math.floor(Math.random() * equipments.length)];
                if (mesState.equipment[eq].status !== 'fault') {
                    mesState.equipment[eq].status = 'fault';
                    mesState.equipment[eq].load = 0;
                    addLog('error', `${eq} è®¾å¤‡æ•…éšœ`);
                    
                    setTimeout(() => {
                        mesState.equipment[eq].status = 'idle';
                        addLog('success', `${eq} è®¾å¤‡æ¢å¤`);
                    }, 3000);
                }
            }
        }

        function updateEnergy() {
            let totalLoad = 0;
            if (mesState.equipment.furnace.status === 'running') totalLoad += 15;
            if (mesState.equipment.rolling.status === 'running') totalLoad += 8;
            if (mesState.equipment.coiler.status === 'running') totalLoad += 2;
            
            mesState.energy.power = 25 + totalLoad + Math.random() * 5 - 2.5;
            mesState.energy.gas = 15000 + totalLoad * 200 + Math.random() * 1000 - 500;
            mesState.energy.water = 800 + totalLoad * 10 + Math.random() * 50 - 25;
            mesState.energy.cost += Math.round(mesState.energy.power * 0.5);
            
            document.getElementById('powerValue').textContent = Math.round(mesState.energy.power);
            document.getElementById('gasValue').textContent = Math.round(mesState.energy.gas / 1000) + 'k';
            document.getElementById('waterValue').textContent = Math.round(mesState.energy.water);
            document.getElementById('energyCost').textContent = mesState.energy.cost.toLocaleString();
        }

        function updateSPC() {
            const time = new Date().toLocaleTimeString();
            const value = 900 + (Math.random() - 0.5) * 60;
            
            if (Math.random() < 0.05) {
                addQualityLog('warning', `æ¸©åº¦å¼‚å¸¸: ${value.toFixed(1)}â„ƒ`);
            }
            
            spcChart.data.labels.push(time);
            spcChart.data.datasets[0].data.push(value);
            
            if (spcChart.data.labels.length > 10) {
                spcChart.data.labels.shift();
                spcChart.data.datasets[0].data.shift();
            }
            
            spcChart.update('none');
        }

        function generateLogs() {
            const messages = [
                'Received data from L2 system',
                'Sent production data to ERP',
                'OPC-UA connection stable',
                'Database sync completed'
            ];
            
            if (Math.random() < 0.3) {
                addLog('info', messages[Math.floor(Math.random() * messages.length)]);
            }
        }

        function addLog(type, message) {
            const log = document.getElementById('systemLog');
            const time = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.className = `log-${type}`;
            div.textContent = `[${type.toUpperCase()}] ${time} - ${message}`;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
            
            if (log.children.length > 20) {
                log.removeChild(log.firstChild);
            }
        }

        function addQualityLog(type, message) {
            const log = document.getElementById('qualityLog');
            const time = new Date().toLocaleTimeString();
            const div = document.createElement('div');
            div.style.color = type === 'warning' ? '#f39c12' : '#e74c3c';
            div.textContent = `[${type.toUpperCase()}] ${time}: ${message}`;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        function updateAllPanels() {
            updatePlanningTable();
            updateEquipmentTable();
            updateTrackingPanel();
            
            // æ›´æ–°å·¥è‰ºå‚æ•°
            document.getElementById('rollingForce').textContent = mesState.equipment.rolling.force + ' kN';
            document.getElementById('coilerTension').textContent = mesState.equipment.coiler.tension + ' MPa';
            document.getElementById('outletThickness').textContent = 
                mesState.currentMaterial ? mesState.currentMaterial.thickness + ' mm' : '-- mm';
            
            // æ›´æ–°æŠ¥è¡¨
            const tbody = document.getElementById('reportsTable');
            if (mesState.completedCoils.length > 0) {
                tbody.innerHTML = mesState.completedCoils.slice(-5).map(coil => `
                    <tr>
                        <td>COIL-${coil.materialId.split('-')[1]}</td>
                        <td>${coil.weight}</td>
                        <td>${coil.time}</td>
                        <td><span class="badge badge-sm ${coil.quality === 'åˆæ ¼' ? 'bg-success' : 'bg-danger'}">${coil.quality}</span></td>
                    </tr>
                `).reverse().join('');
            }
            
            // æ›´æ–°KPI
            const totalCoils = mesState.completedCoils.length;
            const qualified = mesState.completedCoils.filter(c => c.quality === 'åˆæ ¼').length;
            if (totalCoils > 0) {
                document.getElementById('yieldRate').textContent = ((qualified / totalCoils) * 100).toFixed(1) + '%';
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initSystem);
    </script>
</body>
</html>
