<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MES ‰∫íÂä®ÊºîÁ§∫ - Âà∂ÈÄ†ÊâßË°åÁ≥ªÁªü</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Microsoft YaHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .production-line {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            position: relative;
            overflow: hidden;
            min-height: 300px;
        }

        .stage {
            width: 150px;
            height: 80px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin: 0 20px;
            position: relative;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .stage:hover {
            transform: translateY(-2px);
        }

        .stage-slab-yard { background: linear-gradient(135deg, #95a5a6, #7f8c8d); }
        .stage-furnace { background: linear-gradient(135deg, #e74c3c, #c0392b); }
        .stage-rolling { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .stage-coiler { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .stage-coil-yard { background: linear-gradient(135deg, #9b59b6, #8e44ad); }

        .stage-data {
            position: absolute;
            bottom: -40px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 12px;
            color: #666;
            font-weight: normal;
        }

        .production-path {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #bdc3c7, #95a5a6);
            z-index: 1;
            border-radius: 2px;
        }

        .stages-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 2;
        }

        .slab {
            width: 40px;
            height: 20px;
            background: linear-gradient(135deg, #34495e, #2c3e50);
            position: absolute;
            border-radius: 3px;
            z-index: 3;
            transition: all 0.5s ease;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .slab.in-furnace {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            box-shadow: 0 0 15px rgba(231, 76, 60, 0.6);
        }

        .slab.coil {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        .tooltip-custom {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .control-panel {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .btn-custom {
            background: linear-gradient(135deg, #3498db, #2980b9);
            border: none;
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-custom:hover {
            background: linear-gradient(135deg, #2980b9, #1f5f87);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn-optimize {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .btn-optimize:hover {
            background: linear-gradient(135deg, #e67e22, #d35400);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }

        .btn-dispatch {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        .btn-dispatch:hover {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .task-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            background: #fafafa;
        }

        .task-item {
            background: white;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 4px solid #3498db;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .task-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }

        .coil-yard {
            min-height: 100px;
            border: 2px dashed #bdc3c7;
            border-radius: 10px;
            padding: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: flex-start;
            align-content: flex-start;
        }

        .finished-coil {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        .finished-coil:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .modal-custom {
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content-custom {
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-running { background: #2ecc71; }
        .status-stopped { background: #e74c3c; }
        .status-warning { background: #f39c12; }

        .metric-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .metric-label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .simulation-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }

        .production-stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }

        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .alert-custom {
            border-radius: 10px;
            border: none;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <nav class="navbar navbar-expand-lg navbar-dark">
                <div class="container-fluid">
                    <span class="navbar-brand">üè≠ MES ‰∫íÂä®ÊºîÁ§∫</span>
                    <div class="d-flex">
                        <span class="navbar-text">Âà∂ÈÄ†ÊâßË°åÁ≥ªÁªü</span>
                    </div>
                </div>
            </nav>
        </div>
    </div>

    <!-- ‰ªøÁúüÊéßÂà∂ -->
    <div class="simulation-controls">
        <div class="d-flex flex-column align-items-center">
            <span class="status-indicator" id="simulationStatus"></span>
            <small id="simulationText">Â∑≤ÂÅúÊ≠¢</small>
            <button class="btn btn-sm btn-custom mt-2" onclick="toggleSimulation()">
                <span id="toggleText">ÂêØÂä®</span>
            </button>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Ê®°Âùó 1: ‰∏ª‰ª™Ë°®ÊùøÂíåÂèØËßÜÂåñÁîü‰∫ßÁ∫ø -->
        <div class="row">
            <div class="col-12">
                <div class="production-line">
                    <h3 class="mb-4">üè≠ Áîü‰∫ßÁ∫øÂèØËßÜÂåñ</h3>
                    <div class="production-path"></div>
                    <div class="stages-container">
                        <div class="stage stage-slab-yard">
                            <div>
                                <div>ÊùøÂùØÂ∫ì</div>
                                <div class="stage-data">
                                    <div>Êï∞Èáè: <span id="slabYardCount">0</span></div>
                                    <div>Ê∏©Â∫¶: 25¬∞C</div>
                                </div>
                            </div>
                        </div>
                        <div class="stage stage-furnace">
                            <div>
                                <div>Âä†ÁÉ≠ÁÇâ</div>
                                <div class="stage-data">
                                    <div>Ê∏©Â∫¶: <span id="furnaceTemp">1250</span>¬∞C</div>
                                    <div>Áä∂ÊÄÅ: <span id="furnaceStatus">Â∞±Áª™</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="stage stage-rolling">
                            <div>
                                <div>ËΩßÊú∫</div>
                                <div class="stage-data">
                                    <div>ÈÄüÂ∫¶: <span id="rollingSpeed">15</span> m/s</div>
                                    <div>ÂéãÂäõ: <span id="rollingForce">2500</span> kN</div>
                                </div>
                            </div>
                        </div>
                        <div class="stage stage-coiler">
                            <div>
                                <div>Âç∑ÂèñÊú∫</div>
                                <div class="stage-data">
                                    <div>ËΩ¨ÈÄü: <span id="coilerRpm">45</span> RPM</div>
                                    <div>Âº†Âäõ: <span id="coilerTension">180</span> MPa</div>
                                </div>
                            </div>
                        </div>
                        <div class="stage stage-coil-yard">
                            <div>
                                <div>Èí¢Âç∑Â∫ì</div>
                                <div class="stage-data">
                                    <div>Êï∞Èáè: <span id="coilYardCount">0</span></div>
                                    <div>ÂÆπÈáè: 100</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ê®°Âùó 2: Áîü‰∫ßËÆ°Âàí‰∏éË∞ÉÂ∫¶ -->
        <div class="row">
            <div class="col-md-6">
                <div class="control-panel">
                    <h4 class="mb-3">üìã Áîü‰∫ßËÆ°Âàí</h4>
                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-optimize" onclick="optimizeSchedule()">
                            üîß ‰ºòÂåñÊéíÁ®ã
                        </button>
                        <button class="btn btn-dispatch" onclick="dispatchPlan()" id="dispatchBtn">
                            üöÄ ‰∏ãËææËÆ°Âàí
                        </button>
                        <button class="btn btn-custom" onclick="resetSchedule()">
                            üîÑ ÈáçÁΩÆ
                        </button>
                    </div>
                    <div class="task-list" id="taskList">
                        <!-- ‰ªªÂä°Â∞ÜÁî±JavaScriptÂ°´ÂÖÖ -->
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="control-panel">
                    <h4 class="mb-3">üìä Áîü‰∫ßÊåáÊ†á</h4>
                    <div class="production-stats">
                        <div class="metric-card">
                            <div class="metric-value" id="totalProduced">0</div>
                            <div class="metric-label">ÊÄª‰∫ßÈáè</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="currentThroughput">0</div>
                            <div class="metric-label">ÊØèÂ∞èÊó∂‰∫ßÈáè</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="qualityRate">0%</div>
                            <div class="metric-label">ÂêàÊ†ºÁéá</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ê®°Âùó 3: Èí¢Âç∑Â∫ì & Ê®°Âùó 4: Êä•Ë°®‰ª™Ë°®Êùø -->
        <div class="row">
            <div class="col-md-6">
                <div class="control-panel">
                    <h4 class="mb-3">üèóÔ∏è ÊàêÂìÅÈí¢Âç∑Â∫ì</h4>
                    <div class="coil-yard" id="coilYard">
                        <div style="width: 100%; text-align: center; color: #95a5a6; padding: 20px;">
                            ÊöÇÊó†ÊàêÂìÅÈí¢Âç∑„ÄÇÂêØÂä®Áîü‰∫ß‰ª•Êü•ÁúãÁªìÊûú„ÄÇ
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="control-panel">
                    <h4 class="mb-3">üìà Áîü‰∫ßÊä•Ë°®</h4>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead class="table-dark">
                                <tr>
                                    <th>Èí¢Âç∑ÁºñÂè∑</th>
                                    <th>Èí¢Áßç</th>
                                    <th>Áä∂ÊÄÅ</th>
                                    <th>ÂÆåÊàêÊó∂Èó¥</th>
                                </tr>
                            </thead>
                            <tbody id="productionTable">
                                <tr>
                                    <td colspan="4" class="text-center text-muted">ÊöÇÊó†Áîü‰∫ßÊï∞ÊçÆ</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÂõæË°®Âå∫Âüü -->
        <div class="row">
            <div class="col-md-6">
                <div class="chart-container">
                    <h5>Ë¥®ÈáèÂàÜÂ∏É</h5>
                    <canvas id="qualityChart" width="400" height="200"></canvas>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-container">
                    <h5>Â∞èÊó∂‰∫ßÈáè</h5>
                    <canvas id="outputChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- ‰∫ßÂìÅË∞±Á≥ªÊ®°ÊÄÅÊ°Ü -->
    <div class="modal fade modal-custom" id="genealogyModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content modal-content-custom">
                <div class="modal-header">
                    <h5 class="modal-title">üîç ‰∫ßÂìÅË∞±Á≥ª‰∏éË¥®ÈáèËøΩÊ∫Ø</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="genealogyContent">
                        <!-- ÂÜÖÂÆπÂ∞ÜÁî±JavaScriptÂ°´ÂÖÖ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Â∑•ÂÖ∑ÊèêÁ§∫ -->
    <div class="tooltip-custom" id="customTooltip"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ========================
        // ÂÖ®Â±ÄÁä∂ÊÄÅÁÆ°ÁêÜ
        // ========================
        
        let simulationState = {
            isRunning: false,
            currentTasks: [],
            dispatchedTasks: [],
            activeSlabs: [],
            finishedCoils: [],
            simulationTime: 0,
            productionMetrics: {
                totalProduced: 0,
                hourlyOutput: [],
                qualityStats: { qualified: 0, defective: 0 }
            }
        };

        let simulationInterval = null;
        let charts = {};

        // ÂàùÂßãÁîü‰∫ß‰ªªÂä°
        const initialTasks = [
            { id: 'ÊùøÂùØ-001', grade: 'Q235', width: 1500, thickness: 250, length: 12000 },
            { id: 'ÊùøÂùØ-002', grade: 'Q345', width: 1200, thickness: 200, length: 10000 },
            { id: 'ÊùøÂùØ-003', grade: 'Q235', width: 1800, thickness: 300, length: 15000 },
            { id: 'ÊùøÂùØ-004', grade: 'SS400', width: 1000, thickness: 180, length: 8000 },
            { id: 'ÊùøÂùØ-005', grade: 'Q345', width: 1600, thickness: 220, length: 11000 },
            { id: 'ÊùøÂùØ-006', grade: 'Q235', width: 1400, thickness: 280, length: 13000 },
            { id: 'ÊùøÂùØ-007', grade: 'SS400', width: 1100, thickness: 160, length: 9000 },
            { id: 'ÊùøÂùØ-008', grade: 'Q345', width: 1700, thickness: 240, length: 14000 }
        ];

        // Áîü‰∫ßÈò∂ÊÆµÈÖçÁΩÆ
        const stagePositions = [
            { name: 'slabYard', x: 75 },
            { name: 'furnace', x: 245 },
            { name: 'rolling', x: 415 },
            { name: 'coiler', x: 585 },
            { name: 'coilYard', x: 755 }
        ];

        // ========================
        // ÂàùÂßãÂåñ
        // ========================
        
        document.addEventListener('DOMContentLoaded', function() {
            initializeApplication();
        });

        function initializeApplication() {
            simulationState.currentTasks = [...initialTasks];
            updateTaskList();
            updateSimulationStatus();
            initializeCharts();
            setupEventListeners();
            updateMetrics();
        }

        function setupEventListeners() {
            // Â∑•ÂÖ∑ÊèêÁ§∫ÂäüËÉΩ
            document.addEventListener('mousemove', function(e) {
                const tooltip = document.getElementById('customTooltip');
                if (tooltip.style.opacity === '1') {
                    tooltip.style.left = (e.clientX + 10) + 'px';
                    tooltip.style.top = (e.clientY - 30) + 'px';
                }
            });
        }

        // ========================
        // Ê®°Âùó 2: Áîü‰∫ßËÆ°Âàí
        // ========================
        
        function updateTaskList() {
            const taskList = document.getElementById('taskList');
            if (simulationState.currentTasks.length === 0) {
                taskList.innerHTML = '<div class="text-center text-muted">Êó†ÂèØÁî®‰ªªÂä°</div>';
                return;
            }

            taskList.innerHTML = simulationState.currentTasks.map(task => `
                <div class="task-item fade-in">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${task.id}</strong>
                            <div class="small text-muted">Èí¢Áßç: ${task.grade} | ÂÆΩÂ∫¶: ${task.width}mm</div>
                        </div>
                        <div class="text-end">
                            <div class="small">ÈïøÂ∫¶: ${task.length}mm</div>
                            <div class="small">ÂéöÂ∫¶: ${task.thickness}mm</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function optimizeSchedule() {
            // ‰ºòÂåñÁÆóÊ≥ïÔºöÂÖàÊåâÈí¢ÁßçÊéíÂ∫èÔºåÂÜçÊåâÂÆΩÂ∫¶ÊéíÂ∫è
            simulationState.currentTasks.sort((a, b) => {
                if (a.grade !== b.grade) {
                    return a.grade.localeCompare(b.grade);
                }
                return a.width - b.width;
            });
            
            updateTaskList();
            showNotification('ËÆ°Âàí‰ºòÂåñÊàêÂäüÔºÅ', 'success');
        }

        function dispatchPlan() {
            if (simulationState.currentTasks.length === 0) {
                showNotification('Ê≤°ÊúâÂèØ‰∏ãËææÁöÑ‰ªªÂä°ÔºÅ', 'warning');
                return;
            }

            simulationState.dispatchedTasks = [...simulationState.currentTasks];
            simulationState.currentTasks = [];
            updateTaskList();
            
            showNotification(`ÊàêÂäü‰∏ãËææ ${simulationState.dispatchedTasks.length} ‰∏™‰ªªÂä°ÔºÅ`, 'success');
            
            if (!simulationState.isRunning) {
                toggleSimulation();
            }
        }

        function resetSchedule() {
            simulationState.currentTasks = [...initialTasks];
            simulationState.dispatchedTasks = [];
            updateTaskList();
            showNotification('ËÆ°ÂàíÂ∑≤ÈáçÁΩÆ‰∏∫ÂàùÂßãÁä∂ÊÄÅ', 'info');
        }

        // ========================
        // Ê®°Âùó 1: ‰ªøÁúüÂºïÊìé
        // ========================
        
        function toggleSimulation() {
            if (simulationState.isRunning) {
                stopSimulation();
            } else {
                startSimulation();
            }
            updateSimulationStatus();
        }

        function startSimulation() {
            if (simulationState.dispatchedTasks.length === 0) {
                showNotification('ËØ∑ÂÖà‰∏ãËææÁîü‰∫ßËÆ°ÂàíÔºÅ', 'warning');
                return;
            }
            
            simulationState.isRunning = true;
            simulationInterval = setInterval(simulationTick, 2000);
            showNotification('Áîü‰∫ß‰ªøÁúüÂ∑≤ÂêØÂä®', 'success');
        }

        function stopSimulation() {
            simulationState.isRunning = false;
            if (simulationInterval) {
                clearInterval(simulationInterval);
                simulationInterval = null;
            }
            showNotification('Áîü‰∫ß‰ªøÁúüÂ∑≤ÂÅúÊ≠¢', 'info');
        }

        function updateSimulationStatus() {
            const statusIndicator = document.getElementById('simulationStatus');
            const statusText = document.getElementById('simulationText');
            const toggleText = document.getElementById('toggleText');
            
            if (simulationState.isRunning) {
                statusIndicator.className = 'status-indicator status-running pulse';
                statusText.textContent = 'ËøêË°å‰∏≠';
                toggleText.textContent = 'ÂÅúÊ≠¢';
            } else {
                statusIndicator.className = 'status-indicator status-stopped';
                statusText.textContent = 'Â∑≤ÂÅúÊ≠¢';
                toggleText.textContent = 'ÂêØÂä®';
            }
        }

        function simulationTick() {
            simulationState.simulationTime += 2;
            
            // Ê†πÊçÆÈúÄË¶ÅÂºïÂÖ•Êñ∞ÊùøÂùØ
            introduceNewSlab();
            
            // Êõ¥Êñ∞Áé∞ÊúâÊùøÂùØ
            updateActiveSlabs();
            
            // Êõ¥Êñ∞Â∑•ÊÆµÊï∞ÊçÆ
            updateStageData();
            
            // Êõ¥Êñ∞ÊåáÊ†á
            updateMetrics();
            
            // Êõ¥Êñ∞ÂõæË°®
            updateCharts();
        }

        function introduceNewSlab() {
            if (simulationState.dispatchedTasks.length > 0 && 
                (simulationState.activeSlabs.length === 0 || 
                 simulationState.activeSlabs[simulationState.activeSlabs.length - 1].stage > 0)) {
                
                const task = simulationState.dispatchedTasks.shift();
                const slab = createSlab(task);
                simulationState.activeSlabs.push(slab);
                renderSlab(slab);
            }
        }

        function createSlab(task) {
            return {
                id: task.id,
                originalTask: task,
                stage: 0, // 0: ÊùøÂùØÂ∫ì, 1: Âä†ÁÉ≠ÁÇâ, 2: ËΩßÊú∫, 3: Âç∑ÂèñÊú∫, 4: Èí¢Âç∑Â∫ì
                position: stagePositions[0].x,
                startTime: simulationState.simulationTime,
                stageHistory: [{
                    stage: 'ÊùøÂùØÂ∫ì',
                    timestamp: new Date().toLocaleTimeString(),
                    data: { temperature: 25, status: 'Â∞±Áª™' }
                }],
                qualityData: generateQualityData()
            };
        }

        function generateQualityData() {
            const data = [];
            for (let i = 0; i < 10; i++) {
                data.push({
                    time: i,
                    temperature: 1250 + Math.random() * 100 - 50,
                    thickness: 2.5 + Math.random() * 0.5 - 0.25
                });
            }
            return data;
        }

        function updateActiveSlabs() {
            simulationState.activeSlabs.forEach(slab => {
                if (slab.stage < 4) {
                    // ÁßªÂä®Âà∞‰∏ã‰∏ÄÂ∑•ÊÆµ
                    slab.stage++;
                    slab.position = stagePositions[slab.stage].x;
                    
                    // ËÆ∞ÂΩïÂ∑•ÊÆµÂéÜÂè≤
                    const stageNames = ['ÊùøÂùØÂ∫ì', 'Âä†ÁÉ≠ÁÇâ', 'ËΩßÊú∫', 'Âç∑ÂèñÊú∫', 'Èí¢Âç∑Â∫ì'];
                    slab.stageHistory.push({
                        stage: stageNames[slab.stage],
                        timestamp: new Date().toLocaleTimeString(),
                        data: generateStageData(slab.stage)
                    });
                    
                    // Êõ¥Êñ∞ÊùøÂùØÂ§ñËßÇ
                    updateSlabAppearance(slab);
                    
                    // Ê£ÄÊü•ÊòØÂê¶ÂÆåÊàê
                    if (slab.stage === 4) {
                        finishSlab(slab);
                    }
                }
            });
            
            // ‰ªéÊ¥ªÂä®ÂàóË°®‰∏≠ÁßªÈô§Â∑≤ÂÆåÊàêÁöÑÊùøÂùØ
            simulationState.activeSlabs = simulationState.activeSlabs.filter(slab => slab.stage < 4);
        }

        function generateStageData(stage) {
            switch(stage) {
                case 1: // Âä†ÁÉ≠ÁÇâ
                    return { 
                        temperature: Math.floor(1200 + Math.random() * 100),
                        status: 'Âä†ÁÉ≠‰∏≠'
                    };
                case 2: // ËΩßÊú∫
                    return {
                        speed: Math.floor(12 + Math.random() * 8),
                        force: Math.floor(2000 + Math.random() * 1000)
                    };
                case 3: // Âç∑ÂèñÊú∫
                    return {
                        rpm: Math.floor(40 + Math.random() * 20),
                        tension: Math.floor(150 + Math.random() * 60)
                    };
                default:
                    return {};
            }
        }

        function renderSlab(slab) {
            const productionLine = document.querySelector('.production-line');
            const slabElement = document.createElement('div');
            slabElement.className = 'slab';
            slabElement.id = `slab-${slab.id}`;
            slabElement.style.left = slab.position + 'px';
            slabElement.style.top = '50%';
            slabElement.style.transform = 'translateY(-50%)';
            
            // Ê∑ªÂä†ÊÇ¨ÂÅú‰∫ã‰ª∂
            slabElement.addEventListener('mouseenter', function(e) {
                showTooltip(e, slab.id);
            });
            
            slabElement.addEventListener('mouseleave', function() {
                hideTooltip();
            });
            
            productionLine.appendChild(slabElement);
        }

        function updateSlabAppearance(slab) {
            const slabElement = document.getElementById(`slab-${slab.id}`);
            if (!slabElement) return;
            
            // Êõ¥Êñ∞‰ΩçÁΩÆ
            slabElement.style.left = slab.position + 'px';
            
            // Ê†πÊçÆÂ∑•ÊÆµÊõ¥Êñ∞Â§ñËßÇ
            slabElement.className = 'slab';
            if (slab.stage === 1) {
                slabElement.classList.add('in-furnace');
            } else if (slab.stage >= 3) {
                slabElement.classList.add('coil');
            }
        }

        function finishSlab(slab) {
            // ‰ªéÁîü‰∫ßÁ∫ø‰∏äÁßªÈô§
            const slabElement = document.getElementById(`slab-${slab.id}`);
            if (slabElement) {
                slabElement.remove();
            }
            
            // ÂàõÂª∫ÊàêÂìÅÈí¢Âç∑
            const coil = {
                ...slab,
                coilId: `Èí¢Âç∑-${slab.id.split('-')[1]}`,
                finishedTime: new Date().toLocaleTimeString(),
                qualityStatus: Math.random() > 0.1 ? 'ÂêàÊ†º' : '‰∏çÂêàÊ†º'
            };
            
            simulationState.finishedCoils.push(coil);
            
            // Êõ¥Êñ∞ÊåáÊ†á
            simulationState.productionMetrics.totalProduced++;
            if (coil.qualityStatus === 'ÂêàÊ†º') {
                simulationState.productionMetrics.qualityStats.qualified++;
            } else {
                simulationState.productionMetrics.qualityStats.defective++;
            }
            
            // Âú®Èí¢Âç∑Â∫ì‰∏≠Ê∏≤Êüì
            renderFinishedCoil(coil);
            
            // Êõ¥Êñ∞Áîü‰∫ßË°®Ê†º
            updateProductionTable();
        }

        function renderFinishedCoil(coil) {
            const coilYard = document.getElementById('coilYard');
            
            // Â¶ÇÊûúËøôÊòØÁ¨¨‰∏Ä‰∏™Èí¢Âç∑ÔºåÊ∏ÖÈô§Âç†‰ΩçÁ¨¶
            if (simulationState.finishedCoils.length === 1) {
                coilYard.innerHTML = '';
            }
            
            const coilElement = document.createElement('div');
            coilElement.className = 'finished-coil fade-in';
            coilElement.textContent = coil.coilId.split('-')[1];
            coilElement.title = `ÁÇπÂáªÊü•ÁúãËØ¶ÊÉÖ: ${coil.coilId}`;
            
            if (coil.qualityStatus === '‰∏çÂêàÊ†º') {
                coilElement.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
            }
            
            coilElement.addEventListener('click', function() {
                showGenealogyModal(coil);
            });
            
            coilYard.appendChild(coilElement);
        }

        // ========================
        // Ê®°Âùó 3: ‰∫ßÂìÅË∞±Á≥ª
        // ========================
        
        function showGenealogyModal(coil) {
            const modal = new bootstrap.Modal(document.getElementById('genealogyModal'));
            const content = document.getElementById('genealogyContent');
            
            content.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Âü∫Êú¨‰ø°ÊÅØ</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Èí¢Âç∑ÁºñÂè∑:</strong></td><td>${coil.coilId}</td></tr>
                            <tr><td><strong>ÂéüÂßãÊùøÂùØ:</strong></td><td>${coil.id}</td></tr>
                            <tr><td><strong>Èí¢ÁßçÁâåÂè∑:</strong></td><td>${coil.originalTask.grade}</td></tr>
                            <tr><td><strong>ÂÆΩÂ∫¶:</strong></td><td>${coil.originalTask.width}mm</td></tr>
                            <tr><td><strong>Ë¥®ÈáèÁä∂ÊÄÅ:</strong></td>
                                <td><span class="badge ${coil.qualityStatus === 'ÂêàÊ†º' ? 'bg-success' : 'bg-danger'}">${coil.qualityStatus}</span></td>
                            </tr>
                            <tr><td><strong>ÂÆåÊàêÊó∂Èó¥:</strong></td><td>${coil.finishedTime}</td></tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>Â∑•Ëâ∫ÂéÜÁ®ã</h6>
                        <div class="timeline">
                            ${coil.stageHistory.map(stage => `
                                <div class="mb-2">
                                    <small class="text-muted">${stage.timestamp}</small>
                                    <div><strong>${stage.stage}</strong></div>
                                    ${Object.entries(stage.data).map(([key, value]) => 
                                        `<small>${getChineseLabel(key)}: ${value}</small>`
                                    ).join('<br>')}
                                </div>
                            `).join('<hr class="my-2">')}
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Ë¥®ÈáèÊõ≤Á∫ø</h6>
                        <canvas id="genealogyChart" width="400" height="200"></canvas>
                    </div>
                </div>
            `;
            
            modal.show();
            
            // Ê®°ÊÄÅÊ°ÜÊòæÁ§∫ÂêéÂàõÂª∫Ë¥®ÈáèÂõæË°®
            setTimeout(() => {
                createGenealogyChart(coil.qualityData);
            }, 300);
        }

        function getChineseLabel(key) {
            const labels = {
                'temperature': 'Ê∏©Â∫¶',
                'status': 'Áä∂ÊÄÅ',
                'speed': 'ÈÄüÂ∫¶',
                'force': 'ÂéãÂäõ',
                'rpm': 'ËΩ¨ÈÄü',
                'tension': 'Âº†Âäõ'
            };
            return labels[key] || key;
        }

        function createGenealogyChart(qualityData) {
            const ctx = document.getElementById('genealogyChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: qualityData.map(d => `T${d.time}`),
                    datasets: [{
                        label: 'Ê∏©Â∫¶ (¬∞C)',
                        data: qualityData.map(d => d.temperature),
                        borderColor: 'rgb(231, 76, 60)',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        yAxisID: 'y'
                    }, {
                        label: 'ÂéöÂ∫¶ (mm)',
                        data: qualityData.map(d => d.thickness),
                        borderColor: 'rgb(52, 152, 219)',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }

        // ========================
        // Ê®°Âùó 4: Êä•Ë°®‰∏éÊåáÊ†á
        // ========================
        
        function updateMetrics() {
            document.getElementById('totalProduced').textContent = simulationState.productionMetrics.totalProduced;
            document.getElementById('slabYardCount').textContent = simulationState.currentTasks.length + simulationState.dispatchedTasks.length;
            document.getElementById('coilYardCount').textContent = simulationState.finishedCoils.length;
            
            // ËÆ°ÁÆóÂ∞èÊó∂‰∫ßÈáè
            const currentHour = Math.floor(simulationState.simulationTime / 3600);
            if (simulationState.productionMetrics.hourlyOutput.length <= currentHour) {
                simulationState.productionMetrics.hourlyOutput.push(0);
            }
            
            const hourlyRate = simulationState.productionMetrics.totalProduced > 0 ? 
                Math.floor((simulationState.productionMetrics.totalProduced / (simulationState.simulationTime / 3600)) * 10) / 10 : 0;
            document.getElementById('currentThroughput').textContent = hourlyRate;
            
            // ËÆ°ÁÆóÂêàÊ†ºÁéá
            const total = simulationState.productionMetrics.qualityStats.qualified + simulationState.productionMetrics.qualityStats.defective;
            const qualityRate = total > 0 ? Math.floor((simulationState.productionMetrics.qualityStats.qualified / total) * 100) : 0;
            document.getElementById('qualityRate').textContent = qualityRate + '%';
        }

        function updateStageData() {
            // Êõ¥Êñ∞Âä†ÁÉ≠ÁÇâÊï∞ÊçÆ
            document.getElementById('furnaceTemp').textContent = Math.floor(1200 + Math.random() * 100);
            document.getElementById('furnaceStatus').textContent = simulationState.activeSlabs.some(s => s.stage === 1) ? 'Âä†ÁÉ≠‰∏≠' : 'Â∞±Áª™';
            
            // Êõ¥Êñ∞ËΩßÊú∫Êï∞ÊçÆ
            document.getElementById('rollingSpeed').textContent = Math.floor(12 + Math.random() * 8);
            document.getElementById('rollingForce').textContent = Math.floor(2000 + Math.random() * 1000);
            
            // Êõ¥Êñ∞Âç∑ÂèñÊú∫Êï∞ÊçÆ
            document.getElementById('coilerRpm').textContent = Math.floor(40 + Math.random() * 20);
            document.getElementById('coilerTension').textContent = Math.floor(150 + Math.random() * 60);
        }

        function updateProductionTable() {
            const tableBody = document.getElementById('productionTable');
            
            if (simulationState.finishedCoils.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">ÊöÇÊó†Áîü‰∫ßÊï∞ÊçÆ</td></tr>';
                return;
            }
            
            tableBody.innerHTML = simulationState.finishedCoils.slice(-10).reverse().map(coil => `
                <tr>
                    <td>${coil.coilId}</td>
                    <td>${coil.originalTask.grade}</td>
                    <td><span class="badge ${coil.qualityStatus === 'ÂêàÊ†º' ? 'bg-success' : 'bg-danger'}">${coil.qualityStatus}</span></td>
                    <td>${coil.finishedTime}</td>
                </tr>
            `).join('');
        }

        function initializeCharts() {
            // Ë¥®ÈáèÂõæË°®
            const qualityCtx = document.getElementById('qualityChart').getContext('2d');
            charts.quality = new Chart(qualityCtx, {
                type: 'pie',
                data: {
                    labels: ['ÂêàÊ†º', '‰∏çÂêàÊ†º'],
                    datasets: [{
                        data: [95, 5],
                        backgroundColor: ['#27ae60', '#e74c3c']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // ‰∫ßÈáèÂõæË°®
            const outputCtx = document.getElementById('outputChart').getContext('2d');
            charts.output = new Chart(outputCtx, {
                type: 'bar',
                data: {
                    labels: ['Á¨¨1Â∞èÊó∂', 'Á¨¨2Â∞èÊó∂', 'Á¨¨3Â∞èÊó∂', 'Á¨¨4Â∞èÊó∂', 'Á¨¨5Â∞èÊó∂'],
                    datasets: [{
                        label: 'Èí¢Âç∑‰∫ßÈáè',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: '#3498db'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateCharts() {
            // Êõ¥Êñ∞Ë¥®ÈáèÂõæË°®
            const qualified = simulationState.productionMetrics.qualityStats.qualified;
            const defective = simulationState.productionMetrics.qualityStats.defective;
            charts.quality.data.datasets[0].data = [qualified, defective];
            charts.quality.update();
            
            // Êõ¥Êñ∞‰∫ßÈáèÂõæË°®
            const currentHour = Math.floor(simulationState.simulationTime / 3600);
            if (currentHour < 5) {
                charts.output.data.datasets[0].data[currentHour] = simulationState.productionMetrics.totalProduced;
                charts.output.update();
            }
        }

        // ========================
        // ÂÆûÁî®ÂáΩÊï∞
        // ========================
        
        function showTooltip(event, slabId) {
            const tooltip = document.getElementById('customTooltip');
            tooltip.textContent = slabId;
            tooltip.style.opacity = '1';
            tooltip.style.left = (event.clientX + 10) + 'px';
            tooltip.style.top = (event.clientY - 30) + 'px';
        }

        function hideTooltip() {
            const tooltip = document.getElementById('customTooltip');
            tooltip.style.opacity = '0';
        }

        function showNotification(message, type) {
            // ÂàõÂª∫ÈÄöÁü•ÂÖÉÁ¥†
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-custom position-fixed`;
            notification.style.cssText = 'top: 100px; right: 20px; z-index: 1050; min-width: 300px;';
            notification.innerHTML = `
                <div class="d-flex align-items-center">
                    <div class="flex-grow-1">${message}</div>
                    <button type="button" class="btn-close btn-close-white" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // 3ÁßíÂêéËá™Âä®ÁßªÈô§
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 3000);
        }

        // ========================
        // ÊºîÁ§∫Êï∞ÊçÆÂ°´ÂÖÖ
        // ========================
        
        function populateDemoData() {
            // Ê≠§ÂáΩÊï∞ÂèØÁî®‰∫éÊºîÁ§∫Êó∂Âø´ÈÄüÂ°´ÂÖÖÊï∞ÊçÆ
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    if (simulationState.dispatchedTasks.length > 0) {
                        const task = simulationState.dispatchedTasks.shift();
                        const slab = createSlab(task);
                        slab.stage = 4; // Âø´ËøõÂà∞ÂÆåÊàêÁä∂ÊÄÅ
                        finishSlab(slab);
                    }
                }, i * 1000);
            }
        }

        // Ê∑ªÂä†ÈîÆÁõòÂø´Êç∑ÈîÆÁî®‰∫éÊºîÁ§∫
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'd') {
                e.preventDefault();
                populateDemoData();
                showNotification('ÊºîÁ§∫Êï∞ÊçÆÂ∑≤Â°´ÂÖÖÔºÅ', 'info');
            }
        });
    </script>
</body>
</html>
